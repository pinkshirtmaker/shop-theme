<nav class="header-nav hide-scrollbar" d ata-target="site-header.nav">
  <ul class="header-nav__top list-reset">
    {% for tier_1 in list.links %}
      {% liquid
        assign dropdown_block = null
        assign dropdown_banner_count = 0
        assign tier_index = forloop.index

        for block in section.blocks
          if block.settings.menu_item_position == tier_index
            assign dropdown_block = block
          endif
        endfor

        for i in (1..3)
          assign prefix = 'banner_' | append: i | append: '_'
          assign image_key = prefix | append: 'image'
          assign caption_key = prefix | append: 'caption'
          assign url_key = prefix | append: 'url'

          assign image = dropdown_block.settings[image_key]
          assign caption = dropdown_block.settings[caption_key]
          assign url = dropdown_block.settigs[url_key]

          unless image == null and caption == empty and url == null
            assign dropdown_banner_count = dropdown_banner_count | plus: 1
          endunless
        endfor
      %}

      <li>
        {% if tier_1.links.size == 0 %}
          <a
            class="header-nav__link header-nav__link--top-level {% if tier_1.active %}is-active{% endif %}"
            href="{{ tier_1.url }}"
          >
            {{- tier_1.title -}}
          </a>
        {% else %}
          <details class="header-nav__details disclosure-reset" data-target="site-header.details" tabindex="0">
            <summary class="header-nav__link header-nav__link--top-level {% if tier_1.active %}is-active{% endif %}">
              {{ tier_1.title }}
              {% render 'icon-direction', icon: 'arrow-right' %}
            </summary>

            <div class="header-nav__dropdown header-nav__dropdown--top hide-scrollbar" tabindex="0">
              <div class="header-nav__dropdown-grid {% if dropdown_banner_count >= 3 %}header-nav__dropdown-grid--wide{% endif %}">
                <div class="header-nav__dropdown-main">
                  <button class="header-nav__back header-nav__link button-reset" data-target="site-header.back">
                    {% render 'icon-direction', icon: 'arrow-left' %}
                    {{ tier_1.title }}
                  </button>

                  {% unless dropdown_block and dropdown_block.settings.hide_shop_all %}
                    <a class="header-nav__all text-button" href="{{ tier_1.url }}">
                      {{ 'sections.header.shop_all' | t }}
                      {{ tier_1.title | downcase }}
                      {% render 'icon-direction', icon: 'arrow-right' %}
                    </a>
                  {% endunless %}

                  <ul class="header-nav__list-grid list-reset">
                    {% for tier_2 in tier_1.links %}
                      <li>
                        {% if tier_2.links.size == 0 %}
                          <a class="header-nav__link" href="{{ tier_2.url }}">{{ tier_2.title }}</a>
                        {% else %}
                          <details class="disclosure-reset" data-target="site-header.nested-details">
                            <summary class="header-nav__link header-nav__title text-subheading">
                              {{ tier_2.title }}
                              {% render 'icon-direction', icon: 'arrow-right' %}
                            </summary>

                            <div class="header-nav__dropdown hide-scrollbar" data-target="site-header.nested-dropdown">
                              <button
                                class="header-nav__back header-nav__link button-reset"
                                data-target="site-header.back"
                              >
                                {% render 'icon-direction', icon: 'arrow-left' %}
                                {{ tier_2.title }}
                              </button>

                              <ul class="header-nav__list list-reset">
                                {% for tier_3 in tier_2.links %}
                                  <li>
                                    <a class="header-nav__link" href="{{ tier_3.url }}">{{ tier_3.title }}</a>
                                  </li>
                                {% endfor %}
                              </ul>
                            </div>
                          </details>
                        {% endif %}
                      </li>
                    {% endfor %}
                  </ul>

                  {% if dropdown_block %}
                    {% unless dropdown_block.settings.swatch_links_list == blank
                      or dropdown_block.settings.swatch_links_list.links.size == 0
                    %}
                      <div class="header-nav__quick-links">
                        {% unless dropdown_block.settings.swatch_links_heading == empty %}
                          <p class="header-nav__quick-links-heading text-subheading">
                            {{ dropdown_block.settings.swatch_links_heading }}
                          </p>
                        {% endunless %}

                        <detect-overflow>
                          <div class="quick-links indicate-overflow">
                            <div
                              class="quick-links__container hide-scrollbar"
                              data-target="detect-overflow.scroll-container"
                            >
                              {% for link in dropdown_block.settings.swatch_links_list.links %}
                                {% liquid
                                  assign title = link.title | split: ':' | first | strip
                                  assign color = link.title | split: ':' | last | strip
                                %}
                                <a
                                  class="swatch"
                                  href="{{ link.url }}"
                                  style="--color: {{ color }}"
                                >
                                  <span class="visually-hidden">{{ title }}</span>
                                </a>
                              {% endfor %}
                            </div>
                          </div>
                        </detect-overflow>
                      </div>
                    {% endunless %}

                    {% unless dropdown_block.settings.quick_links_list == blank
                      or dropdown_block.settings.quick_links_list.links.size == 0
                    %}
                      <div class="header-nav__quick-links">
                        {% unless dropdown_block.settings.quick_links_heading == empty %}
                          <p class="header-nav__quick-links-heading text-subheading">
                            {{ dropdown_block.settings.quick_links_heading }}
                          </p>
                        {% endunless %}

                        <detect-overflow>
                          <div class="quick-links indicate-overflow">
                            <div
                              class="quick-links__container hide-scrollbar"
                              data-target="detect-overflow.scroll-container"
                            >
                              {% for link in dropdown_block.settings.quick_links_list.links %}
                                <a
                                  class="quick-links__link text-subheading"
                                  href="{{ link.url }}"
                                >
                                  {{ link.title }}
                                </a>
                              {% endfor %}
                            </div>
                          </div>
                        </detect-overflow>
                      </div>
                    {% endunless %}
                  {% endif %}
                </div>

                {% if dropdown_block %}
                  <div class="header-nav__banners">
                    {% for i in (1..3) %}
                      {% liquid
                        assign prefix = 'banner_' | append: i | append: '_'
                        assign image_key = prefix | append: 'image'
                        assign caption_key = prefix | append: 'caption'
                        assign url_key = prefix | append: 'url'

                        assign image = dropdown_block.settings[image_key]
                        assign caption = dropdown_block.settings[caption_key]
                        assign url = dropdown_block.settings[url_key]
                      %}

                      {% unless image == null and caption == empty and url == null %}
                        <div class="header-nav-banner">
                          {% if image %}
                            {{
                              image
                              | image_url: width: 906
                              | image_tag: class: 'header-nav-banner__image', loading: 'lazy'
                              | link_to: url
                            }}
                          {% else %}
                            <div class="header-nav-banner__image"></div>
                          {% endif %}

                          {% unless caption == empty %}
                            {% liquid
                              assign caption_tag = 'p'

                              if url
                                assign caption_tag = 'a'
                              endif
                            %}

                            <{{ caption_tag }}
                              class="header-nav-banner__caption text-button"
                              {% if url %}
                                href="{{ url }}"
                              {% endif %}
                            >
                              {{ caption }}

                              {% if url %}
                                {% render 'growing-arrow' %}
                              {% endif %}
                            </{{ caption_tag }}>
                          {% endunless %}
                        </div>
                      {% endunless %}
                    {% endfor %}
                  </div>
                {% endif %}
              </div>

              {% if dropdown_block %}
                {% unless dropdown_block.settings.footer_content == empty
                  and dropdown_block.settings.footer_link_label == empty
                  or dropdown_block.settings.footer_link_url == null
                %}
                  <div class="header-dropdown-footer">
                    <div class="header-dropdown-footer__container">
                      {% unless dropdown_block.settings.footer_content == empty %}
                        <p class="header-dropdown-footer__item text-h4 no-margin">
                          {{ dropdown_block.settings.footer_content }}
                        </p>
                      {% endunless %}

                      {% unless dropdown_block.settings.footer_link_label == empty
                        or dropdown_block.settings.footer_link_url == null
                      %}
                        <a
                          class="header-dropdown-footer__item text-h4 no-margin"
                          href="{{ dropdown_block.settings.footer_link_url }}"
                        >
                          {{- dropdown_block.settings.footer_link_label -}}
                        </a>
                      {% endunless %}
                    </div>
                  </div>
                {% endunless %}
              {% endif %}
            </div>
          </details>
        {% endif %}
      </li>
    {% endfor %}

    {% if shop.customer_accounts_enabled %}
      <li class="header-nav__mobile-item">
        <a href="{{ customer_url }}" class="header-nav__link">
          {%- render 'icon-misc', icon: 'profile' -%}
          {{ customer_label -}}
          {% render 'icon-direction', icon: 'arrow-right' %}
        </a>
      </li>
    {% endif %}

    {% unless section.settings.announcement_bar_link_text == empty
      or section.settings.announcement_bar_link_url == empty
    %}
      <li class="header-nav__mobile-item">
        <a href="{{ customer_url }}" class="header-nav__link">
          {{- section.settings.announcement_bar_link_text }}
          {% render 'icon-direction', icon: 'arrow-right' -%}
        </a>
      </li>
    {% endunless %}

    <div class="header-nav__mobile-item">
      <button class="button-reset header-nav__link" data-toggle="localization">
        {{ localization.country.name }} /
        {{ localization.country.currency.symbol | append: localization.country.currency.iso_code }}
        {% render 'icon-direction', icon: 'arrow-right' %}
      </button>
    </div>
  </ul>
</nav>
